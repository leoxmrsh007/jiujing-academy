"""
ä¹ç»ä¹¦é™¢ Skill for OpenClaw
åŸºäºäºŒé˜¶å¿ƒæ™ºç†è®ºçš„ä¸­åç»å…¸æ•™å­¦å¹³å°
"""

import sys
sys.path.insert(0, '/mnt/d/Philosophy-AI-Platform')

from core import PhilosophyAI


class JiujingAcademySkill:
    """
    ä¹ç»ä¹¦é™¢ Skill
    
    è§¦å‘è¯ï¼š
    - ä¹ç»ã€ç»å…¸ã€å‘¨æ˜“ã€è®ºè¯­ã€é“å¾·ç»
    - å­¦ä¹ [ç»å…¸å]ã€è¯»[ç»å…¸å]
    - å„’å®¶ã€é“å®¶ã€ä½›å®¶ã€åŒ»å®¶
    
    åŠŸèƒ½ï¼š
    1. ä¹ç»ç»å…¸é—®ç­”
    2. è¯¾ç¨‹ä½“ç³»å¯¼èˆª
    3. ç‰ˆæœ¬å¯¹ç…§é˜…è¯»
    4. ä¸­å¤–å¯¹æ¯”ç ”ç©¶
    """
    
    def __init__(self):
        self.ai = PhilosophyAI()
        self.classics = {
            'å‘¨æ˜“': 'zhouyi',
            'é“å¾·ç»': 'daodejing',
            'åº„å­': 'zhuangzi',
            'è®ºè¯­': 'lunyu',
            'å­Ÿå­': 'mengzi',
            'å¤§å­¦': 'daxue',
            'ä¸­åº¸': 'zhongyong',
            'é»„å¸å†…ç»': 'huangdineijing',
            'å…­ç¥–å›ç»': 'liuzutanjing'
        }
        
    def on_message(self, message: str, context: dict = None) -> dict:
        """å¤„ç†ç”¨æˆ·æ¶ˆæ¯"""
        message = message.strip()
        
        # æ£€æµ‹æ„å›¾
        intent = self._detect_intent(message)
        
        if intent == 'classic_list':
            return self._show_classics_list()
        
        elif intent == 'classic_query':
            classic_name = self._extract_classic_name(message)
            if classic_name:
                return self._query_classic(classic_name)
        
        elif intent == 'course_info':
            return self._show_course_info()
        
        elif intent == 'comparison':
            return self._show_comparison_info()
        
        # é»˜è®¤ï¼šç»å…¸é—®ç­”
        return self._default_response(message)
    
    def _detect_intent(self, message: str) -> str:
        """æ£€æµ‹ç”¨æˆ·æ„å›¾"""
        msg = message.lower()
        
        if any(w in msg for w in ['ä¹ç»', 'æœ‰å“ªäº›ç»å…¸', 'è¯¾ç¨‹åˆ—è¡¨']):
            return 'classic_list'
        
        if any(w in msg for w in ['è¯¾ç¨‹', 'æ€ä¹ˆå­¦', 'ä½“ç³»']):
            return 'course_info'
        
        if any(w in msg for w in ['å¯¹æ¯”', 'æ¯”è¾ƒ', 'ä¸­å¤–']):
            return 'comparison'
        
        # æ£€æŸ¥æ˜¯å¦æåˆ°æŸéƒ¨ç»å…¸
        for name in self.classics.keys():
            if name in message:
                return 'classic_query'
        
        return 'default'
    
    def _extract_classic_name(self, message: str) -> str:
        """æå–ç»å…¸åç§°"""
        for name in self.classics.keys():
            if name in message:
                return name
        return None
    
    def _show_classics_list(self) -> dict:
        """æ˜¾ç¤ºä¹ç»åˆ—è¡¨"""
        response = """## ğŸ“š ä¹ç»ä¹¦é™¢ - ç»å…¸åˆ—è¡¨

**å„’å®¶å››ç»**
1. ğŸ“– **è®ºè¯­** - å­”å­è¨€è¡Œå½•ï¼Œä»ä¹‰ç¤¼æ™º
2. ğŸ“– **å­Ÿå­** - æ€§å–„è®ºï¼Œä»æ”¿ç‹é“
3. ğŸ“– **å¤§å­¦** - ä¸‰çº²å…«ç›®ï¼Œä¿®é½æ²»å¹³
4. ğŸ“– **ä¸­åº¸** - è¯šæ˜ä¹‹é“ï¼Œä¸­å’Œä¹‹å¢ƒ

**é“å®¶äºŒç»**
5. ğŸ“– **é“å¾·ç»** - é“æ³•è‡ªç„¶ï¼Œæ— ä¸ºè€Œæ²»
6. ğŸ“– **åº„å­** - é€é¥é½ç‰©ï¼Œç²¾ç¥è‡ªç”±

**æ˜“å­¦**
7. ğŸ“– **å‘¨æ˜“** - é˜´é˜³å˜åŒ–ï¼Œå¤©äººåˆä¸€

**åŒ»å®¶**
8. ğŸ“– **é»„å¸å†…ç»** - é˜´é˜³äº”è¡Œï¼Œå…»ç”Ÿä¹‹é“

**ç¦…å®—**
9. ğŸ“– **å…­ç¥–å›ç»** - é¡¿æ‚Ÿæˆä½›ï¼Œè‡ªæ€§æ¸…å‡€

---
ğŸ’¡ **å­¦ä¹ æ–¹æ³•**ï¼š
- ç›´æ¥é—®ï¼š"ä»€ä¹ˆæ˜¯[ç»å…¸å]çš„æ ¸å¿ƒæ€æƒ³ï¼Ÿ"
- æ·±å…¥å­¦ï¼š"è¯»[ç»å…¸å]ç¬¬ä¸€ç« "
- å¯¹æ¯”ç ”ï¼š"å„’å®¶å’Œé“å®¶çš„åŒºåˆ«"

æ‚¨æƒ³ä»å“ªéƒ¨ç»å…¸å¼€å§‹ï¼Ÿ
"""
        return {'response': response, 'type': 'classic_list'}
    
    def _query_classic(self, classic_name: str) -> dict:
        """æŸ¥è¯¢ç‰¹å®šç»å…¸"""
        # ä½¿ç”¨ PhilosophyAI æŸ¥è¯¢
        question = f"{classic_name}çš„æ ¸å¿ƒæ€æƒ³æ˜¯ä»€ä¹ˆï¼Ÿ"
        result = self.ai.ask(question)
        
        response = f"""## ğŸ“– {classic_name}

{result['answer']}

---
ğŸ’¡ **æ·±å…¥æ¢ç´¢**ï¼š
{chr(10).join(f"{i+1}. {q}" for i, q in enumerate(result.get('reflection_questions', [])[:3]))}

**ç›¸å…³æ¦‚å¿µ**ï¼š{', '.join(result.get('concepts', [])[:5])}

ç»§ç»­å­¦ä¹ è¯·è¯´ï¼š
- "è¯»{classic_name}ç¬¬ä¸€ç« "
- "{classic_name}çš„ä½œè€…æ˜¯ï¼Ÿ"
- "æ¯”è¾ƒ{classic_name}å’Œ[å¦ä¸€éƒ¨ç»å…¸]"
"""
        return {'response': response, 'type': 'classic_detail'}
    
    def _show_course_info(self) -> dict:
        """æ˜¾ç¤ºè¯¾ç¨‹ä½“ç³»"""
        response = """## ğŸ“ ä¹ç»ä¹¦é™¢ - è¯¾ç¨‹ä½“ç³»

### ä¸€ã€åŸæ–‡ç²¾è¯»
**é€ç« é€å¥ç ”è¯»ç»å…¸åŸæ–‡**
- ç¹ä½“åŸæ–‡å¯¹ç…§
- å†ä»£é‡è¦æ³¨æœ¬
- ç™½è¯è¯‘æ–‡è¾…åŠ©
- å…³é”®è¯æ±‡è§£æ

### äºŒã€æ³¨ç–ç ”è®¨
**å†ä»£é‡è¦æ³¨æœ¬å¯¹æ¯”ç ”ç©¶**
- å‘¨æ˜“ï¼šç‹å¼¼æ³¨ã€ç¨‹é¢ä¼ 
- è®ºè¯­ï¼šæœ±ç†¹é›†æ³¨ã€åˆ˜å®æ¥ æ­£ä¹‰
- é“å¾·ç»ï¼šç‹å¼¼æ³¨ã€æ²³ä¸Šå…¬æ³¨
- åº„å­ï¼šéƒ­è±¡æ³¨ã€æˆç„è‹±ç–

### ä¸‰ã€æ€æƒ³é˜é‡Š
**æ·±å…¥ç†è§£ç»å…¸çš„æ ¸å¿ƒæ€æƒ³**
- å„’å®¶ï¼šä»ä¹‰ç¤¼æ™ºã€ä¿®é½æ²»å¹³
- é“å®¶ï¼šé“æ³•è‡ªç„¶ã€é€é¥æ— ä¸º
- æ˜“å­¦ï¼šé˜´é˜³å˜åŒ–ã€å¤©äººåˆä¸€
- åŒ»å®¶ï¼šé˜´é˜³å¹³è¡¡ã€æ²»æœªç—…
- ç¦…å®—ï¼šé¡¿æ‚Ÿè§æ€§ã€è‡ªæ€§æ¸…å‡€

### å››ã€ä¸­å¤–å¯¹æ¯”
**ä¸è¥¿æ–¹å“²å­¦ã€å…¶ä»–ä¼ ç»Ÿçš„å¯¹è¯**
- å„’å®¶ vs äºšé‡Œå£«å¤šå¾·å¾·æ€§è®º
- é“å®¶ vs æ–¯å¤šè‘›å­¦æ´¾
- ç¦…å®— vs å­˜åœ¨ä¸»ä¹‰
- æ˜“å­¦ vs è¿‡ç¨‹å“²å­¦

### äº”ã€ç°ä»£åº”ç”¨
**ç»å…¸æ™ºæ…§åœ¨ç°ä»£ç”Ÿæ´»ä¸­çš„åº”ç”¨**
- ä¸ªäººä¿®å…»ä¸å¿ƒç†å¥åº·
- é¢†å¯¼åŠ›ä¸ç®¡ç†æ™ºæ…§
- äººé™…å…³ç³»ä¸æ²Ÿé€š
- å†³ç­–æ€ç»´ä¸åˆ¤æ–­

---
ğŸ’¡ **äºŒé˜¶å¿ƒæ™ºæ•™å­¦æ³•**ï¼š
ä¸åªæ˜¯çŸ¥è¯†ä¼ æˆï¼Œæ›´æ˜¯æ€ç»´è®­ç»ƒ
æ¯ä¸ªé—®é¢˜éƒ½ä¼šå¼•å¯¼æ‚¨æ·±å…¥åæ€...

ä»å“ªé—¨è¯¾ç¨‹å¼€å§‹ï¼Ÿ
"""
        return {'response': response, 'type': 'course_info'}
    
    def _show_comparison_info(self) -> dict:
        """æ˜¾ç¤ºä¸­å¤–å¯¹æ¯”ä¿¡æ¯"""
        response = """## ğŸŒ ä¹ç»ä¹¦é™¢ - ä¸­å¤–å“²å­¦å¯¹æ¯”

### ä¸œäºšå“²å­¦åœˆ
**ä¸­å›½ï¼ˆä¹ç»ï¼‰**
- å„’å®¶ï¼šä»ä¹‰ç¤¼æ™ºä¿¡
- é“å®¶ï¼šé“æ³•è‡ªç„¶
- ä½›å®¶ï¼šç©ºæ€§æ™ºæ…§
- åŒ»å®¶ï¼šé˜´é˜³äº”è¡Œ

**æ—¥æœ¬**
- ç¥é“ï¼šè‡ªç„¶å´‡æ‹œ
- ç¦…å®—ï¼šèŒ¶é“ã€èŠ±é“
- é˜³æ˜å­¦ï¼šçŸ¥è¡Œåˆä¸€

**éŸ©å›½**
- æ€§ç†å­¦ï¼šç†æ°”è®º
- å®å­¦ï¼šç»ä¸–è‡´ç”¨

### è¥¿æ–¹å“²å­¦å¯¹ç…§
| ä¸­å›½æ¦‚å¿µ | è¥¿æ–¹å¯¹åº” | å¯¹è¯ç‚¹ |
|---------|---------|-------|
| ä» | çˆ±ï¼ˆAgapeï¼‰ | ä¼¦ç†å­¦ |
| é“ | é€»å„æ–¯ï¼ˆLogosï¼‰ | å½¢è€Œä¸Šå­¦ |
| é˜´é˜³ | è¾©è¯æ³• | æ€ç»´æ–¹å¼ |
| æ— ä¸º | è‡ªç„¶æ³• | æ”¿æ²»å“²å­¦ |
| é¡¿æ‚Ÿ | ç›´è§‚ | è®¤è¯†è®º |

### ç»å…¸å¯¹æ¯”ç ”ç©¶
- **è®ºè¯­ vs å°¼å„é©¬å¯ä¼¦ç†å­¦**ï¼šå¾·æ€§å¦‚ä½•åŸ¹å…»ï¼Ÿ
- **é“å¾·ç» vs ç†æƒ³å›½**ï¼šç†æƒ³ç¤¾ä¼šå¦‚ä½•æ„å»ºï¼Ÿ
- **åº„å­ vs å­˜åœ¨ä¸æ—¶é—´**ï¼šäººçš„æœ¬çœŸçŠ¶æ€
- **å‘¨æ˜“ vs è¿‡ç¨‹ä¸å®åœ¨**ï¼šå˜åŒ–çš„å“²å­¦

---
ğŸ’¡ **ç ”ç©¶æ–¹æ³•**ï¼š
ä¸å¯»æ±‚ç®€å•ç­‰åŒï¼Œè€Œæ˜¯æ·±åº¦å¯¹è¯
å‘ç°å„è‡ªä¼ ç»Ÿçš„ç‹¬ç‰¹æ™ºæ…§

æƒ³æ·±å…¥å“ªç»„å¯¹æ¯”ï¼Ÿ
"""
        return {'response': response, 'type': 'comparison'}
    
    def _default_response(self, message: str) -> dict:
        """é»˜è®¤å“åº”"""
        # ä½¿ç”¨ PhilosophyAI å›ç­”
        result = self.ai.ask(message)
        
        response = f"""ğŸ‹ **ä¹ç»ä¹¦é™¢**

{result['answer']}

---
ğŸ“š **å­¦ä¹ å»ºè®®**ï¼š
- è¯´"ä¹ç»åˆ—è¡¨"æŸ¥çœ‹å…¨éƒ¨ç»å…¸
- è¯´"è¯¾ç¨‹ä½“ç³»"äº†è§£å­¦ä¹ æ–¹æ³•
- è¯´"ä¸­å¤–å¯¹æ¯”"æ¢ç´¢è·¨æ–‡åŒ–å¯¹è¯

ç»§ç»­æé—®æˆ–é€‰æ‹©ä»¥ä¸Šé€‰é¡¹~
"""
        return {'response': response, 'type': 'default'}
    
    def get_help(self) -> str:
        """è·å–å¸®åŠ©"""
        return """
ğŸ‹ ä¹ç»ä¹¦é™¢ - ä½¿ç”¨æŒ‡å—

**å¿«é€Ÿå¼€å§‹ï¼š**
- "ä¹ç»æœ‰å“ªäº›" - æŸ¥çœ‹ç»å…¸åˆ—è¡¨
- "å­¦ä¹ è®ºè¯­" - å¼€å§‹å­¦ä¹ æŸéƒ¨ç»å…¸
- "è¯¾ç¨‹ä½“ç³»" - äº†è§£å­¦ä¹ æ–¹æ³•
- "ä¸­å¤–å¯¹æ¯”" - è·¨æ–‡åŒ–å“²å­¦å¯¹è¯

**æ·±å…¥å­¦ä¹ ï¼š**
- "ä»€ä¹ˆæ˜¯ä»ä¹‰ï¼Ÿ"
- "é“å¾·ç»ç¬¬ä¸€ç« "
- "å„’å®¶å’Œé“å®¶çš„åŒºåˆ«"
- "å‘¨æ˜“çš„æ ¸å¿ƒæ€æƒ³"

**ç‰¹è‰²åŠŸèƒ½ï¼š**
âœ¨ äºŒé˜¶å¿ƒæ™ºæ•™å­¦ - æ¯ä¸ªå›ç­”éƒ½å¼•å¯¼æ·±åº¦åæ€
âœ¨ ç‰ˆæœ¬å¯¹ç…§ - åŸæ–‡ã€æ³¨ç–ã€è¯‘æ–‡å¯¹ç…§é˜…è¯»
âœ¨ çŸ¥è¯†å›¾è°± - æ¦‚å¿µå…³è”ï¼Œç³»ç»Ÿç†è§£

å¼€å§‹æ‚¨çš„ç»å…¸å­¦ä¹ ä¹‹æ—…å§ï¼
"""


# OpenClaw æ¥å£
skill = JiujingAcademySkill()

def handle_message(message: str, context: dict = None) -> str:
    """OpenClaw è°ƒç”¨å…¥å£"""
    result = skill.on_message(message, context)
    return result['response']


if __name__ == "__main__":
    # æµ‹è¯•
    print("ğŸ‹ ä¹ç»ä¹¦é™¢ Skill - æµ‹è¯•")
    print("=" * 50)
    
    test_messages = [
        "ä¹ç»æœ‰å“ªäº›",
        "ä»€ä¹ˆæ˜¯è®ºè¯­",
        "è¯¾ç¨‹ä½“ç³»"
    ]
    
    for msg in test_messages:
        print(f"\nç”¨æˆ·: {msg}")
        result = skill.on_message(msg)
        print(f"AI: {result['response'][:200]}...")
    
    print("\n" + "=" * 50)
    print("âœ… æµ‹è¯•å®Œæˆ")